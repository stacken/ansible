---

- hosts: kvm-servers
  roles:
    - postfix
    - network
    - motd
  tasks:
    - name: Check for vmx and svm CPU flags
      shell: "grep flags /proc/cpuinfo | egrep -q '(vmx|svm)'"
      changed_when: False

    - name: Install packages for KVM
      yum:
        name: "{{ item }}"
        state: present
        enablerepo: extras
      with_items:
        - libvirt
        - qemu-kvm
        - libvirt-client
        - libvirt-daemon
        - libvirt-daemon-kvm
        - virt-install
        - bridge-utils
        - bind-utils
        - nfs-utils

    - name: Start libvirtd service, load it on boot
      service: name=libvirtd state=started enabled=yes

    - name: Hostfix for broken rpc service file
      lineinfile:
        dest: /usr/lib/systemd/system/rpc-statd.service
        regexp: '^After=network.target'
        line: "After=network.target nss-lookup.target rpcbind.service"
      notify: reload nfs

    - name: Set hostname from inventory
      hostname: name={{ inventory_hostname_short }}

    - name: SELINUX | Get virt_use_nfs
      shell: getsebool virt_use_nfs
      register: virt_use_nfs
      changed_when: False

    - name: SELINUX | Set virt_use_nfs=on
      shell: setsebool -P virt_use_nfs=on
      when: virt_use_nfs.stdout.find('off') != -1

    - name: Setup mount FS NFS share
      mount:
        fstype: nfs
        name: /var/lib/libvirt/images
        src: "{{ nfsfs_addr }}:{{ nfsfs_path }}"
        opts: "{{ nfsfs_opts }}"
        state: "{{ item }}"
      with_items:
        - present
        - mounted

    - name: Chronjob to manage permissions on NFS share
      cron:
        name: "KVM NFS share premissions"
        minute: 0
        job: "chown -R qemu:qemu /var/lib/libvirt/images/"

  handlers:
    - name: reload nfs
      service: name=nfs state=restarted
