---

- hosts: kvm-servers
  roles:
    - postfix
    - network
    - motd
    - gluster-repos
  tasks:
    - name: Check for vmx and svm CPU flags
      shell: "grep flags /proc/cpuinfo | egrep -q '(vmx|svm)'"
      changed_when: False

    - name: Install packages for KVM
      yum:
        name: "{{ item }}"
        state: present
        enablerepo: extras
      with_items:
        - libvirt
        - qemu-kvm
        - libvirt-client
        - libvirt-daemon
        - libvirt-daemon-kvm
        - virt-install
        - bridge-utils
        - bind-utils
        - nfs-utils

    - name: Start libvirtd service, load it on boot
      service: name=libvirtd state=started enabled=yes

    - name: Hostfix for broken rpc service file
      lineinfile:
        dest: /usr/lib/systemd/system/rpc-statd.service
        regexp: '^After=network.target'
        line: "After=network.target nss-lookup.target rpcbind.service"
      notify: reload nfs

    - name: Set hostname from inventory
      hostname: name={{ inventory_hostname_short }}

    - name: SELINUX | Set to permissive
      lineinfile:
        dest: /etc/sysconfig/selinux
        regexp: '^SELINUX='
        line: "SELINUX=permissive"

    - name: Install GlusterFS FUSE package
      yum: name=glusterfs-fuse

    - name: Set local adress to file servers in hosts
      lineinfile:
        dest: /etc/hosts
        regexp: "{{ item.host }}"
        line: "{{ item.ip }} {{ item.host }} {{ item.host }}.stacken.kth.se"
      with_items:
        - host: mount-kilimanjaro
          ip: 10.0.32.151
